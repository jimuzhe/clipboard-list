<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>Favicon 获取测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .test-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .favicon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }

        .url {
            font-family: monospace;
            color: #666;
        }

        .test-btn {
            padding: 8px 16px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }

        .loading {
            color: #666;
            font-style: italic;
        }
    </style>
</head>

<body>
    <h1>🔗 Favicon 获取功能测试</h1>
    <p>测试自动获取网站图标功能</p>

    <button class="test-btn" onclick="testAllFavicons()">开始测试</button>

    <div id="test-results"></div>

    <script>
        // 测试用的网站列表
        const testUrls = [
            'https://github.com',
            'https://stackoverflow.com',
            'https://chat.openai.com',
            'https://translate.google.com',
            'https://www.douban.com',
            'https://www.bing.com',
            'https://zh.wikipedia.org',
            'https://codepen.io',
            'https://www.youtube.com',
            'https://www.bilibili.com'
        ];
        async function getFaviconForUrl(url) {
            try {
                // 使用xxapi.cn的API接口
                const apiUrl = `https://v2.xxapi.cn/api/ico?url=${encodeURIComponent(url)}`;

                console.log('🔍 正在获取网站图标:', url);

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                    }
                });

                if (!response.ok) {
                    throw new Error(`API请求失败: ${response.status}`);
                }

                const data = await response.json();

                // 检查API返回的数据结构
                if (data && data.code === 200 && data.data) {
                    console.log('✅ 成功获取网站图标:', data.data);
                    return data.data;
                } else if (data && data.ico) {
                    console.log('✅ 成功获取网站图标:', data.ico);
                    return data.ico;
                } else {
                    throw new Error('API返回格式不正确: ' + JSON.stringify(data));
                }
            } catch (error) {
                console.warn('❌ 获取favicon失败:', error.message);

                // 如果API失败，回退到备用方案
                try {
                    const urlObj = new URL(url);
                    const domain = urlObj.hostname;
                    const fallbackUrl = `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
                    console.log('🔄 使用备用方案:', fallbackUrl);
                    return fallbackUrl;
                } catch (fallbackError) {
                    console.warn('❌ 备用方案也失败了:', fallbackError.message);
                    return null;
                }
            }
        }

        async function testAllFavicons() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<div class="loading">正在测试获取网站图标...</div>';

            const results = [];

            for (const url of testUrls) {
                try {
                    const faviconUrl = await getFaviconForUrl(url);
                    results.push({
                        url,
                        faviconUrl,
                        success: !!faviconUrl
                    });
                } catch (error) {
                    results.push({
                        url,
                        faviconUrl: null,
                        success: false,
                        error: error.message
                    });
                }
            }

            // 显示结果
            let html = '<h2>测试结果</h2>';
            results.forEach(result => {
                html += `
                    <div class="test-item">
                        ${result.success ? 
                            `<img class="favicon" src="${result.faviconUrl}" alt="favicon" onerror="this.src='data:image/svg+xml,<svg xmlns=\\"http://www.w3.org/2000/svg\\" viewBox=\\"0 0 24 24\\"><circle cx=\\"12\\" cy=\\"12\\" r=\\"10\\" fill=\\"none\\" stroke=\\"currentColor\\" stroke-width=\\"2\\"/></svg>'" />` :
                            '<div class="favicon" style="background: #ddd; display: flex; align-items: center; justify-content: center;">❌</div>'
                        }
                        <div>
                            <div><strong>${new URL(result.url).hostname}</strong></div>
                            <div class="url">${result.url}</div>
                            ${result.success ? 
                                `<div style="color: green;">✅ 成功获取图标</div>` :
                                `<div style="color: red;">❌ 获取失败: ${result.error || '未知错误'}</div>`
                            }
                        </div>
                    </div>
                `;
            });

            resultsDiv.innerHTML = html;
        }
    </script>
</body>

</html>